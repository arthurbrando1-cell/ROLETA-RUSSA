<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROLETA RUSSA - Multiplayer Extremo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Orbitron:wght@400;700;900&family=Russo+One&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            min-height: 100vh;
            touch-action: manipulation;
        }

        .font-horror { font-family: 'Creepster', cursive; }
        .font-russo { font-family: 'Russo One', sans-serif; }

        /* Animated Background */
        .bg-animated {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(80, 0, 0, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(60, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(20, 0, 0, 0.5) 0%, transparent 70%),
                linear-gradient(180deg, #0a0000 0%, #000000 50%, #050000 100%);
            z-index: -2;
        }

        /* Blood Rain */
        .blood-rain {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .blood-drop {
            position: absolute;
            width: 3px;
            height: 20px;
            background: linear-gradient(to bottom, transparent, #8b0000, #ff0000);
            border-radius: 50%;
            animation: bloodFall linear infinite;
            opacity: 0.6;
        }
        @keyframes bloodFall {
            0% { transform: translateY(-100vh) rotate(15deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100vh) rotate(15deg); opacity: 0; }
        }

        /* Floating Particles */
        .floating-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, rgba(255,0,0,0.8), transparent);
            border-radius: 50%;
            animation: floatParticle 8s ease-in-out infinite;
        }
        @keyframes floatParticle {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(50px, -100px) scale(1.5); opacity: 0.8; }
        }

        /* Scanlines */
        .scanlines {
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.3) 2px,
                rgba(0, 0, 0, 0.3) 4px
            );
            pointer-events: none;
            z-index: 1000;
            opacity: 0.1;
        }

        /* Vignette */
        .vignette {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, transparent 20%, rgba(0,0,0,0.9) 100%);
            pointer-events: none;
            z-index: 999;
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(135deg, rgba(15, 0, 0, 0.98) 0%, rgba(5, 0, 0, 0.99) 100%);
            border: 1px solid rgba(255, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.95),
                0 0 200px rgba(100, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.02),
                inset 0 0 150px rgba(80, 0, 0, 0.08);
        }

        /* Neon Border Animation */
        .neon-border {
            position: relative;
        }
        .neon-border::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(45deg, #ff0000, #220000, #ff0000, #440000, #ff0000);
            background-size: 400% 400%;
            border-radius: inherit;
            z-index: -1;
            animation: neonPulse 3s ease infinite;
            filter: blur(12px);
            opacity: 0.7;
        }
        @keyframes neonPulse {
            0%, 100% { background-position: 0% 50%; opacity: 0.5; }
            50% { background-position: 100% 50%; opacity: 1; }
        }

        /* Input */
        .input-dark {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 0, 0, 0.15);
            color: #fff;
            transition: all 0.3s ease;
        }
        .input-dark:focus {
            outline: none;
            border-color: rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.4), inset 0 0 40px rgba(255, 0, 0, 0.05);
        }

        /* Buttons */
        .btn-blood {
            background: linear-gradient(135deg, #8b0000 0%, #2d0000 50%, #8b0000 100%);
            background-size: 200% 200%;
            border: 2px solid rgba(255, 50, 50, 0.5);
            color: #fff;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: btnPulse 3s ease infinite;
        }
        @keyframes btnPulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .btn-blood::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-blood:hover::before, .btn-blood:active::before {
            left: 100%;
        }
        .btn-blood:hover, .btn-blood:active {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 50px rgba(139, 0, 0, 0.7), 0 0 80px rgba(255, 0, 0, 0.4);
        }

        .btn-ghost {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }
        .btn-ghost:hover, .btn-ghost:active {
            border-color: rgba(255, 0, 0, 0.7);
            color: #fff;
            background: rgba(255, 0, 0, 0.15);
        }

        /* Room Card */
        .room-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s ease;
            cursor: pointer;
        }
        .room-card:hover, .room-card:active {
            background: rgba(139, 0, 0, 0.4);
            border-color: rgba(139, 0, 0, 0.7);
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 10px 50px rgba(139, 0, 0, 0.4);
        }

        /* Avatar Selection */
        .avatar-option {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(0,0,0,0.6);
        }
        .avatar-option:hover, .avatar-option:active {
            transform: scale(1.2);
            border-color: rgba(255,0,0,0.5);
        }
        .avatar-option.selected {
            border-color: #ff0000;
            box-shadow: 0 0 25px rgba(255,0,0,0.7);
            transform: scale(1.1);
        }

        /* Custom Avatar */
        .custom-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid transparent;
        }
        .custom-avatar.selected {
            border-color: #ff0000;
            box-shadow: 0 0 25px rgba(255,0,0,0.7);
        }

        /* Player Slot */
        .player-slot {
            background: rgba(0, 0, 0, 0.7);
            border: 2px dashed rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        .player-slot.occupied {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.5) 0%, rgba(50, 0, 0, 0.7) 100%);
            border: 2px solid rgba(139, 0, 0, 0.8);
        }
        .player-slot.is-me {
            border-color: #ff0000;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.5);
        }

        /* 3D Labels */
        .label-3d {
            position: absolute;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.97);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .label-3d .avatar-display {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            overflow: hidden;
        }
        .label-3d .avatar-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .label-3d.current-turn {
            border-color: #ff0000;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.9);
            animation: turnPulse 0.7s infinite;
        }
        .label-3d.dead {
            opacity: 0.25;
            text-decoration: line-through;
            color: #555;
        }
        @keyframes turnPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.12); }
        }

        /* Mic Status */
        .mic-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
            padding: 4px 10px;
            border-radius: 12px;
            margin-top: 4px;
        }
        .mic-status.on {
            background: rgba(0, 255, 0, 0.25);
            color: #00ff00;
            animation: micPulse 0.4s infinite;
        }
        .mic-status.off {
            background: rgba(255, 0, 0, 0.25);
            color: #ff4444;
        }
        @keyframes micPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 15px rgba(0,255,0,0.6); }
            50% { opacity: 0.7; box-shadow: 0 0 8px rgba(0,255,0,0.3); }
        }

        /* Chat */
        .chat-container {
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 0, 0, 0.25);
            border-radius: 12px;
        }
        .chat-msg {
            animation: msgSlide 0.3s ease;
        }
        @keyframes msgSlide {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Blood Overlay */
        .blood-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, transparent 10%, rgba(180, 0, 0, 0.95) 100%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 500;
        }

        /* Game Message */
        .game-msg {
            text-shadow: 
                0 0 30px currentColor,
                0 0 60px currentColor,
                0 0 100px currentColor;
        }

        /* Skull Animation */
        @keyframes skullFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        /* Fullscreen button */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,0,0,0.3);
            color: #fff;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .fullscreen-btn:hover {
            background: rgba(139,0,0,0.8);
            transform: scale(1.1);
        }

        /* Mobile Controls */
        .mobile-trigger {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            padding: 25px;
            font-size: 24px;
            z-index: 100;
        }
        @media (max-width: 768px) {
            .mobile-trigger.active {
                display: block;
            }
            #btn-trigger {
                display: none !important;
            }
            .chat-container {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(139, 0, 0, 0.7); border-radius: 3px; }

        /* Responsive */
        @media (max-width: 768px) {
            .glass-card { margin: 10px; }
            .font-horror { font-size: 2rem !important; }
        }
    </style>
</head>
<body>
    <!-- Fullscreen Button -->
    <button id="fullscreen-btn" class="fullscreen-btn">
        <i class="fas fa-expand"></i>
    </button>

    <!-- Background Effects -->
    <div class="bg-animated"></div>
    <div class="blood-rain" id="blood-rain"></div>
    <div id="floating-particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div id="blood-overlay" class="blood-overlay"></div>

    <!-- ========== LOBBY SCREEN ========== -->
    <div id="lobby-screen" class="fixed inset-0 z-50 flex items-center justify-center p-2 md:p-4 overflow-auto">
        <div class="glass-card neon-border rounded-3xl w-full max-w-5xl overflow-hidden my-4">
            
            <!-- Header -->
            <div class="p-6 md:p-8 border-b border-red-900/30 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-red-900/10 via-transparent to-red-900/10"></div>
                <div class="relative flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4 md:gap-6">
                        <div class="text-5xl md:text-6xl" style="animation: skullFloat 3s ease infinite;">üíÄ</div>
                        <div class="text-center md:text-left">
                            <h1 class="font-horror text-4xl md:text-6xl text-red-600 tracking-wider" style="text-shadow: 0 0 40px rgba(255,0,0,0.9);">ROLETA RUSSA</h1>
                            <p class="text-red-500/60 mt-1 text-xs md:text-sm tracking-[0.3em] md:tracking-[0.5em] font-russo">MULTIPLAYER EXTREMO</p>
                        </div>
                    </div>
                    <div id="user-display" class="hidden text-center md:text-right">
                        <p class="text-xs text-red-400/60 uppercase tracking-wider mb-1">Jogando como</p>
                        <div class="flex items-center gap-3 justify-center md:justify-end">
                            <span id="my-avatar-display" class="text-3xl"></span>
                            <span id="my-name-display" class="text-xl md:text-2xl font-bold text-white"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 md:p-8">
                
                <!-- LOGIN VIEW -->
                <div id="login-view" class="flex flex-col items-center justify-center py-4 md:py-8">
                    <div class="w-32 h-32 md:w-40 md:h-40 mb-6 md:mb-8 rounded-full bg-gradient-to-br from-red-900 to-black flex items-center justify-center relative">
                        <div class="absolute inset-0 rounded-full border-2 border-red-600/30 animate-ping"></div>
                        <div class="absolute inset-2 rounded-full border border-red-800/50"></div>
                        <i class="fas fa-skull text-5xl md:text-6xl text-red-500"></i>
                    </div>
                    
                    <h2 class="text-xl md:text-2xl font-russo text-gray-300 mb-4 md:mb-6 tracking-wider">ESCOLHA SEU AVATAR</h2>
                    
                    <!-- Avatar Selection -->
                    <div id="avatar-grid" class="flex gap-2 md:gap-3 mb-4 flex-wrap justify-center max-w-md">
                        <div class="avatar-option selected" data-avatar="üíÄ">üíÄ</div>
                        <div class="avatar-option" data-avatar="üëπ">üëπ</div>
                        <div class="avatar-option" data-avatar="üéÉ">üéÉ</div>
                        <div class="avatar-option" data-avatar="üëª">üëª</div>
                        <div class="avatar-option" data-avatar="ü§°">ü§°</div>
                        <div class="avatar-option" data-avatar="üòà">üòà</div>
                        <div class="avatar-option" data-avatar="üßõ">üßõ</div>
                        <div class="avatar-option" data-avatar="üßü">üßü</div>
                        <div class="avatar-option" data-avatar="‚ò†Ô∏è">‚ò†Ô∏è</div>
                        <div class="avatar-option" data-avatar="üî™">üî™</div>
                    </div>

                    <!-- Custom Avatar Upload -->
                    <div class="mb-6 flex flex-col items-center gap-3">
                        <p class="text-xs text-gray-500">OU USE SUA PR√ìPRIA FOTO:</p>
                        <div class="flex gap-2 flex-wrap justify-center">
                            <label class="btn-ghost px-4 py-2 rounded-lg text-xs cursor-pointer">
                                <i class="fas fa-upload mr-2"></i> UPLOAD
                                <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                            </label>
                            <button id="btn-url-avatar" class="btn-ghost px-4 py-2 rounded-lg text-xs">
                                <i class="fas fa-link mr-2"></i> URL
                            </button>
                        </div>
                        <div id="custom-avatar-preview" class="hidden">
                            <img id="custom-avatar-img" class="custom-avatar" src="" alt="Avatar">
                        </div>
                    </div>
                    
                    <input type="text" id="nickname-input" 
                        class="input-dark w-full max-w-xs px-6 py-4 rounded-xl text-center text-lg md:text-xl font-bold uppercase tracking-wider mb-6"
                        placeholder="SEU NOME" maxlength="12">
                    
                    <button id="btn-enter" class="btn-blood px-8 md:px-12 py-4 rounded-xl font-russo text-base md:text-lg tracking-widest">
                        <i class="fas fa-door-open mr-3"></i> ENTRAR NO INFERNO
                    </button>
                    
                    <p class="text-xs text-red-900 mt-8 md:mt-10 max-w-md text-center px-4">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Conte√∫do +18. Simula√ß√£o apenas. Entretenimento.
                    </p>
                </div>

                <!-- ROOMS VIEW -->
                <div id="rooms-view" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                        
                        <!-- Rooms List -->
                        <div class="md:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-russo text-base md:text-lg text-gray-400 tracking-wider flex items-center gap-3">
                                    <i class="fas fa-door-closed text-red-700"></i> SALAS ABERTAS
                                </h3>
                                <button id="btn-refresh" class="text-gray-600 hover:text-red-500 transition-colors text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i> Atualizar
                                </button>
                            </div>
                            <div id="rooms-list" class="space-y-3 max-h-60 md:max-h-80 overflow-y-auto pr-2">
                                <div class="flex items-center justify-center py-12 md:py-16 text-gray-600">
                                    <div class="w-8 h-8 border-2 border-red-900 border-t-red-500 rounded-full animate-spin mr-4"></div>
                                    Procurando salas...
                                </div>
                            </div>
                        </div>

                        <!-- Create Room -->
                        <div class="glass-card rounded-xl p-5 md:p-6 border border-red-900/30">
                            <h3 class="font-russo text-base md:text-lg text-gray-400 tracking-wider mb-4 md:mb-6 flex items-center gap-3">
                                <i class="fas fa-plus-circle text-red-700"></i> CRIAR SALA
                            </h3>
                            <input type="text" id="room-name-input" 
                                class="input-dark w-full px-4 py-3 rounded-lg text-sm mb-4"
                                placeholder="Nome da sala..." maxlength="20">
                            <button id="btn-create" class="btn-blood w-full py-3 rounded-lg font-russo tracking-wider">
                                CRIAR SALA
                            </button>
                            <div class="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-white/5 space-y-2 md:space-y-3">
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-users w-6 text-red-900"></i> M√°ximo 6 jogadores
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-microphone w-6 text-red-900"></i> Chat de voz
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-comment w-6 text-red-900"></i> Chat de texto
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fas fa-skull-crossbones w-6 text-red-900"></i> Gore extremo
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ========== WAITING ROOM ========== -->
    <div id="waiting-room" class="fixed inset-0 z-40 hidden items-center justify-center p-4">
        <div class="glass-card neon-border rounded-3xl w-full max-w-4xl overflow-hidden">
            <div class="p-4 md:p-6 border-b border-red-900/30 flex items-center justify-between">
                <div>
                    <p class="text-xs text-red-400/60 uppercase tracking-wider">Sala</p>
                    <h2 id="current-room-name" class="text-2xl md:text-3xl font-horror text-red-500"></h2>
                </div>
                <button id="btn-leave-room" class="btn-ghost px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i> Sair
                </button>
            </div>
            
            <div class="p-4 md:p-6">
                <h3 class="text-sm text-gray-500 uppercase tracking-wider mb-4">Jogadores na Mesa</h3>
                <div id="players-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6"></div>
                
                <div id="host-controls" class="hidden border-t border-red-900/30 pt-6">
                    <button id="btn-start-match" class="btn-blood w-full py-4 rounded-xl font-horror text-xl md:text-2xl tracking-widest disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-play mr-3"></i> INICIAR JOGO
                    </button>
                    <p class="text-center text-xs text-gray-600 mt-2">M√≠nimo 2 jogadores</p>
                </div>
                
                <div id="guest-waiting" class="text-center py-6">
                    <div class="w-8 h-8 border-2 border-red-900 border-t-red-500 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-400">Aguardando o host iniciar...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== GAME HUD ========== -->
    <div id="game-hud" class="fixed inset-0 z-30 hidden pointer-events-none">
        <div class="absolute inset-0 p-4 md:p-6 flex flex-col justify-between">
            
            <!-- Top Bar -->
            <div class="flex justify-between items-start pointer-events-auto">
                <button id="btn-leave-game" class="btn-ghost px-3 py-2 rounded-lg text-xs md:text-sm">
                    <i class="fas fa-arrow-left mr-1 md:mr-2"></i> <span class="hidden md:inline">Sair</span>
                </button>
                
                <div class="flex items-center gap-3 md:gap-4">
                    <div id="round-info" class="text-right">
                        <p class="text-xs text-gray-500">RODADA</p>
                        <p id="round-num" class="text-xl md:text-2xl font-horror text-red-500">1</p>
                    </div>
                    <button id="btn-mic" class="w-12 h-12 md:w-14 md:h-14 rounded-full btn-ghost flex items-center justify-center text-xl md:text-2xl border-2">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                </div>
            </div>

            <!-- Center Message -->
            <div id="game-message" class="text-center opacity-0 transition-all duration-500">
                <h2 id="msg-text" class="font-horror text-5xl md:text-7xl text-red-600 game-msg"></h2>
                <p id="msg-sub" class="text-lg md:text-xl text-gray-400 mt-4"></p>
            </div>

            <!-- Bottom -->
            <div class="flex justify-center items-end pb-6 md:pb-10">
                <button id="btn-trigger" class="hidden pointer-events-auto btn-blood px-12 md:px-20 py-6 md:py-8 rounded-2xl font-horror text-3xl md:text-5xl tracking-widest transform hover:scale-105 transition-transform">
                    <i class="fas fa-hand-pointer mr-3 md:mr-4"></i> PUXAR GATILHO
                </button>
                
                <div id="watching-msg" class="hidden text-center">
                    <p class="text-gray-500 text-base md:text-lg"><i class="fas fa-eye mr-2"></i> Aguardando...</p>
                </div>
            </div>
        </div>

        <!-- Mobile Trigger Button -->
        <button id="mobile-trigger" class="mobile-trigger btn-blood font-horror tracking-widest pointer-events-auto">
            <i class="fas fa-hand-pointer mr-3"></i> PUXAR GATILHO
        </button>

        <!-- Chat Box -->
        <div id="chat-box" class="absolute bottom-4 md:bottom-6 left-4 md:left-6 w-72 md:w-80 pointer-events-auto">
            <div class="chat-container overflow-hidden">
                <div class="bg-black/50 px-3 py-2 border-b border-red-900/30">
                    <span class="text-xs text-gray-500 uppercase tracking-wider"><i class="fas fa-comment mr-2"></i>Chat</span>
                </div>
                <div id="chat-messages" class="h-28 md:h-32 overflow-y-auto p-3 space-y-2 text-sm"></div>
                <div class="border-t border-red-900/30 p-2 flex gap-2">
                    <input type="text" id="chat-input" class="input-dark flex-1 px-3 py-2 rounded text-sm" placeholder="Digite..." maxlength="100">
                    <button id="btn-send-chat" class="btn-blood px-4 py-2 rounded text-sm">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D Labels Container -->
    <div id="labels-3d" class="fixed inset-0 pointer-events-none z-20"></div>

    <!-- 3D Canvas -->
    <div id="canvas-container" class="fixed inset-0 z-0"></div>

    <!-- URL Avatar Modal -->
    <div id="url-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/80 p-4">
        <div class="glass-card rounded-xl p-6 max-w-md w-full">
            <h3 class="text-lg font-russo text-gray-300 mb-4">AVATAR POR URL</h3>
            <input type="text" id="avatar-url-input" class="input-dark w-full px-4 py-3 rounded-lg text-sm mb-4" placeholder="Cole a URL da imagem...">
            <div class="flex gap-2">
                <button id="btn-cancel-url" class="btn-ghost flex-1 py-2 rounded-lg text-sm">Cancelar</button>
                <button id="btn-confirm-url" class="btn-blood flex-1 py-2 rounded-lg text-sm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <script type="module">
        // Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, get, update, remove, onValue, onDisconnect } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfdgkO3WzaxXT-djAA6MsLC2m26c9optU",
            authDomain: "slider-io.firebaseapp.com",
            databaseURL: "https://slider-io-default-rtdb.firebaseio.com",
            projectId: "slider-io",
            storageBucket: "slider-io.firebasestorage.app",
            messagingSenderId: "395647141464",
            appId: "1:395647141464:web:251cc58a3e0e90ca262c2d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ====== STATE ======
        let myId = localStorage.getItem('rr_id') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('rr_id', myId);
        let myName = "";
        let myAvatar = "üíÄ";
        let myAvatarUrl = null;
        let currentRoom = null;
        let isHost = false;
        let mySlot = -1;
        let gameData = null;
        let roundNum = 1;

        // 3D
        let scene, camera, renderer, clock;
        let playerMeshes = {};
        let magnumGun, cylinderMesh;
        let particles = [];
        let audioCtx;

        // Mic
        let micStream = null;
        let isMuted = true;

        // DOM
        const $lobby = document.getElementById('lobby-screen');
        const $loginView = document.getElementById('login-view');
        const $roomsView = document.getElementById('rooms-view');
        const $roomsList = document.getElementById('rooms-list');
        const $waitingRoom = document.getElementById('waiting-room');
        const $playersGrid = document.getElementById('players-grid');
        const $gameHud = document.getElementById('game-hud');
        const $labels3d = document.getElementById('labels-3d');
        const $msgText = document.getElementById('msg-text');
        const $msgSub = document.getElementById('msg-sub');
        const $gameMessage = document.getElementById('game-message');
        const $bloodOverlay = document.getElementById('blood-overlay');
        const $chatMessages = document.getElementById('chat-messages');
        const $chatInput = document.getElementById('chat-input');
        const $mobileTrigger = document.getElementById('mobile-trigger');

        // Create blood rain
        const bloodRain = document.getElementById('blood-rain');
        for(let i = 0; i < 40; i++) {
            const drop = document.createElement('div');
            drop.className = 'blood-drop';
            drop.style.left = Math.random() * 100 + '%';
            drop.style.animationDuration = (2 + Math.random() * 3) + 's';
            drop.style.animationDelay = Math.random() * 5 + 's';
            bloodRain.appendChild(drop);
        }

        // Create floating particles
        const floatingContainer = document.getElementById('floating-particles');
        for(let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'floating-particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 8 + 's';
            floatingContainer.appendChild(particle);
        }

        // Fullscreen
        document.getElementById('fullscreen-btn').onclick = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };

        // Avatar selection
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                document.getElementById('custom-avatar-img').classList.remove('selected');
                opt.classList.add('selected');
                myAvatar = opt.dataset.avatar;
                myAvatarUrl = null;
            });
        });

        // Custom avatar upload
        document.getElementById('avatar-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                setCustomAvatar(evt.target.result);
            };
            reader.readAsDataURL(file);
        });

        // URL avatar modal
        document.getElementById('btn-url-avatar').onclick = () => {
            document.getElementById('url-modal').style.display = 'flex';
        };
        document.getElementById('btn-cancel-url').onclick = () => {
            document.getElementById('url-modal').style.display = 'none';
        };
        document.getElementById('btn-confirm-url').onclick = () => {
            const url = document.getElementById('avatar-url-input').value.trim();
            if (url) {
                setCustomAvatar(url);
            }
            document.getElementById('url-modal').style.display = 'none';
        };

        function setCustomAvatar(url) {
            myAvatarUrl = url;
            myAvatar = 'custom';
            document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
            const preview = document.getElementById('custom-avatar-preview');
            const img = document.getElementById('custom-avatar-img');
            img.src = url;
            img.classList.add('selected');
            preview.classList.remove('hidden');
        }

        // ====== LOBBY ======

        document.getElementById('btn-enter').onclick = () => {
            const name = document.getElementById('nickname-input').value.trim();
            if (!name) return alert("Digite seu nome!");
            myName = name.toUpperCase();
            
            if (myAvatarUrl) {
                document.getElementById('my-avatar-display').innerHTML = `<img src="${myAvatarUrl}" class="w-8 h-8 rounded-full object-cover">`;
            } else {
                document.getElementById('my-avatar-display').textContent = myAvatar;
            }
            document.getElementById('my-name-display').textContent = myName;
            document.getElementById('user-display').classList.remove('hidden');
            $loginView.classList.add('hidden');
            $roomsView.classList.remove('hidden');
            listenToRooms();
        };

        document.getElementById('nickname-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('btn-enter').click();
        });

        document.getElementById('btn-create').onclick = async () => {
            const name = document.getElementById('room-name-input').value.trim() || `Sala de ${myName}`;
            const roomRef = push(ref(db, 'rooms'));
            await set(roomRef, {
                name: name,
                hostId: myId,
                hostName: myName,
                status: 'waiting',
                createdAt: Date.now()
            });
            joinRoom(roomRef.key);
        };

        document.getElementById('btn-refresh').onclick = listenToRooms;

        function listenToRooms() {
            onValue(ref(db, 'rooms'), (snap) => {
                $roomsList.innerHTML = '';
                const rooms = snap.val();
                if (!rooms) {
                    $roomsList.innerHTML = '<p class="text-center text-gray-600 py-12">Nenhuma sala. Crie uma!</p>';
                    return;
                }
                
                Object.entries(rooms).forEach(([id, room]) => {
                    const count = room.players ? Object.keys(room.players).length : 0;
                    const isFull = count >= 6;
                    const isPlaying = room.status === 'playing';
                    
                    const div = document.createElement('div');
                    div.className = 'room-card rounded-xl p-4 flex items-center justify-between';
                    div.innerHTML = `
                        <div class="flex items-center gap-3 md:gap-4">
                            <div class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-gradient-to-br from-red-900 to-black flex items-center justify-center text-xl md:text-2xl">
                                üíÄ
                            </div>
                            <div>
                                <p class="font-bold text-white text-base md:text-lg">${room.name}</p>
                                <p class="text-xs text-gray-500">Host: ${room.hostName}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 md:gap-4">
                            ${isPlaying ? '<span class="text-xs text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded"><i class="fas fa-gamepad"></i></span>' : ''}
                            <span class="text-lg md:text-xl font-bold ${isFull ? 'text-red-500' : 'text-green-500'}">${count}/6</span>
                            <i class="fas fa-chevron-right text-gray-700"></i>
                        </div>
                    `;
                    if (!isFull && !isPlaying) {
                        div.onclick = () => joinRoom(id);
                    } else {
                        div.style.opacity = '0.4';
                        div.style.cursor = 'not-allowed';
                    }
                    $roomsList.appendChild(div);
                });
            }, { onlyOnce: true });
        }

        async function joinRoom(roomId) {
            const snap = await get(ref(db, `rooms/${roomId}`));
            const room = snap.val();
            if (!room) return;
            
            const players = room.players || {};
            const count = Object.keys(players).length;
            if (count >= 6) return alert("Sala cheia!");

            const takenSlots = Object.values(players).map(p => p.slot);
            mySlot = 0;
            while (takenSlots.includes(mySlot)) mySlot++;

            currentRoom = roomId;
            isHost = room.hostId === myId;

            const playerRef = ref(db, `rooms/${roomId}/players/${myId}`);
            await set(playerRef, {
                name: myName,
                avatar: myAvatar,
                avatarUrl: myAvatarUrl || null,
                slot: mySlot,
                isDead: false,
                micOn: false
            });
            onDisconnect(playerRef).remove();

            $lobby.classList.add('hidden');
            $waitingRoom.style.display = 'flex';
            document.getElementById('current-room-name').textContent = room.name;

            if (isHost) {
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('guest-waiting').classList.add('hidden');
            }

            // Generate slots
            $playersGrid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`;
                slot.className = 'player-slot rounded-xl p-4 text-center h-28 md:h-32 flex flex-col items-center justify-center';
                slot.innerHTML = `<i class="fas fa-user-slash text-3xl md:text-4xl text-gray-800"></i><p class="text-xs text-gray-700 mt-2">Vazio</p>`;
                $playersGrid.appendChild(slot);
            }

            // Listen to room
            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if (!data) {
                    leaveRoom();
                    return;
                }
                
                gameData = data;
                updateWaitingRoom(data);
                
                if (data.status === 'playing') {
                    startGame(data);
                }
                
                if (data.status === 'restarting') {
                    handleRestart();
                }
            });

            // Chat
            onValue(ref(db, `rooms/${roomId}/chat`), (snap) => {
                const messages = snap.val();
                if (!messages) return;
                $chatMessages.innerHTML = '';
                Object.values(messages).slice(-50).forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-msg';
                    const avatarHtml = msg.avatarUrl 
                        ? `<img src="${msg.avatarUrl}" class="w-4 h-4 rounded-full inline mr-1">`
                        : `<span class="mr-1">${msg.avatar}</span>`;
                    div.innerHTML = `<span class="text-red-500 font-bold">${avatarHtml}${msg.name}:</span> <span class="text-gray-300">${msg.text}</span>`;
                    $chatMessages.appendChild(div);
                });
                $chatMessages.scrollTop = $chatMessages.scrollHeight;
            });
        }

        function updateWaitingRoom(room) {
            const players = room.players || {};
            const count = Object.keys(players).length;

            for (let i = 0; i < 6; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (!slot) continue;
                slot.className = 'player-slot rounded-xl p-4 text-center h-28 md:h-32 flex flex-col items-center justify-center';
                slot.innerHTML = `<i class="fas fa-user-slash text-3xl md:text-4xl text-gray-800"></i><p class="text-xs text-gray-700 mt-2">Vazio</p>`;
            }

            Object.entries(players).forEach(([pid, p]) => {
                const slot = document.getElementById(`slot-${p.slot}`);
                if (!slot) return;
                slot.classList.add('occupied');
                if (pid === myId) slot.classList.add('is-me');
                
                const avatarHtml = p.avatarUrl 
                    ? `<img src="${p.avatarUrl}" class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover mb-2">`
                    : `<div class="text-3xl md:text-4xl mb-2">${p.avatar || 'üíÄ'}</div>`;
                
                slot.innerHTML = `
                    ${avatarHtml}
                    <p class="text-xs md:text-sm font-bold ${pid === myId ? 'text-red-400' : 'text-white'}">${p.name}</p>
                    ${pid === room.hostId ? '<span class="text-xs text-yellow-500"><i class="fas fa-crown"></i></span>' : ''}
                `;
            });

            const startBtn = document.getElementById('btn-start-match');
            if (startBtn) startBtn.disabled = count < 2;
        }

        document.getElementById('btn-leave-room').onclick = leaveRoom;
        document.getElementById('btn-leave-game').onclick = leaveRoom;

        function leaveRoom() {
            if (currentRoom) {
                remove(ref(db, `rooms/${currentRoom}/players/${myId}`));
                get(ref(db, `rooms/${currentRoom}/players`)).then((snap) => {
                    if (!snap.exists()) {
                        remove(ref(db, `rooms/${currentRoom}`));
                    }
                });
            }
            
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop());
                micStream = null;
            }
            
            currentRoom = null;
            mySlot = -1;
            gameData = null;
            roundNum = 1;
            
            $waitingRoom.style.display = 'none';
            $gameHud.classList.add('hidden');
            $lobby.classList.remove('hidden');
            $mobileTrigger.classList.remove('active');
            
            Object.values(playerMeshes).forEach(m => scene?.remove(m));
            playerMeshes = {};
            $labels3d.innerHTML = '';
        }

        document.getElementById('btn-start-match').onclick = async () => {
            const bullet = Math.floor(Math.random() * 6);
            const snap = await get(ref(db, `rooms/${currentRoom}/players`));
            const players = snap.val();
            const slots = Object.values(players).map(p => p.slot).sort((a, b) => a - b);
            
            await update(ref(db, `rooms/${currentRoom}`), {
                status: 'playing',
                bulletPos: bullet,
                chamber: 0,
                currentTurnSlot: slots[0],
                round: 1,
                lastAction: null
            });
        };

        // ====== GAME ======

        function startGame(room) {
            $waitingRoom.style.display = 'none';
            $gameHud.classList.remove('hidden');
            
            // Sempre inicializa o 3D se ainda n√£o existir
            if (!scene) {
                init3D();
            }
            
            // Limpa meshes antigos se houver
            Object.values(playerMeshes).forEach(m => {
                if (scene) scene.remove(m);
            });
            playerMeshes = {};
            $labels3d.innerHTML = '';
            
            // Limpa part√≠culas antigas
            particles.forEach(p => {
                if (scene) scene.remove(p.mesh);
            });
            particles = [];
            
            setupGameLoop();
            showMessage("QUE O JOGO COMECE", "Boa sorte... üíÄ", 2500);
        }

        function setupGameLoop() {
            onValue(ref(db, `rooms/${currentRoom}`), (snap) => {
                const room = snap.val();
                if (!room) return;
                
                gameData = room;
                
                if (room.status === 'playing') {
                    updateGameState(room);
                }
                
                if (room.lastAction) {
                    handleAction(room.lastAction);
                }
            });
        }

        let lastActionTime = 0;
        
        function handleAction(action) {
            if (action.time <= lastActionTime) return;
            lastActionTime = action.time;
            
            if (action.type === 'bang') {
                handleBangSync(action.slot, action.name);
            } else if (action.type === 'click') {
                playSound('click');
                if (cylinderMesh) cylinderMesh.rotation.z += Math.PI / 3;
            }
        }

        function handleBangSync(slot, name) {
            playSound('bang');
            
            const mesh = Object.values(playerMeshes).find(m => m.userData.slot === slot);
            if (mesh) {
                const headPos = mesh.position.clone();
                headPos.y += 9;
                createMassiveGore(headPos);
                
                // Deform and hide head
                if (mesh.userData.headGroup) {
                    // Deformation effect
                    mesh.userData.headGroup.scale.set(0.3, 1.5, 0.3);
                    setTimeout(() => {
                        mesh.userData.headGroup.visible = false;
                    }, 100);
                }
                
                // Fall animation with deformation
                let fall = 0;
                const fallInterval = setInterval(() => {
                    fall += 0.15;
                    mesh.rotation.x = -Math.min(fall, 1.8);
                    mesh.position.y = -5 - fall * 3;
                    
                    // Body deformation during fall
                    if (mesh.userData.torso) {
                        mesh.userData.torso.scale.x = 1 + Math.sin(fall * 10) * 0.1;
                    }
                    
                    if (fall >= 1.8) clearInterval(fallInterval);
                }, 16);
            }
            
            // Gun recoil
            if (magnumGun) {
                magnumGun.rotation.x = -0.6;
                magnumGun.position.z += 0.5;
                setTimeout(() => {
                    magnumGun.rotation.x = 0;
                    magnumGun.position.z -= 0.5;
                }, 150);
            }
            
            // Blood overlay if it's me
            if (slot === mySlot) {
                $bloodOverlay.style.opacity = 1;
                setTimeout(() => $bloodOverlay.style.opacity = 0.6, 300);
            }
        }

        function updateGameState(room) {
            const players = room.players || {};
            const alivePlayers = Object.entries(players).filter(([_, p]) => !p.isDead);
            
            document.getElementById('round-num').textContent = room.round || 1;
            
            // Check winner
            if (alivePlayers.length === 1) {
                const [winnerId, winner] = alivePlayers[0];
                const isMe = winnerId === myId;
                showMessage(
                    isMe ? "VOC√ä VENCEU!" : `${winner.name} VENCEU!`, 
                    isMe ? "Sobrevivente! üèÜ" : "√önico sobrevivente...", 
                    5000
                );
                document.getElementById('btn-trigger').classList.add('hidden');
                $mobileTrigger.classList.remove('active');
                
                if (isHost) {
                    setTimeout(() => {
                        update(ref(db, `rooms/${currentRoom}`), { status: 'restarting' });
                    }, 5000);
                }
                return;
            }
            
            if (alivePlayers.length === 0) {
                showMessage("TODOS MORTOS", "Fim de jogo", 5000);
                if (isHost) {
                    setTimeout(() => {
                        update(ref(db, `rooms/${currentRoom}`), { status: 'restarting' });
                    }, 5000);
                }
                return;
            }

            update3DPlayers(players, room.currentTurnSlot);
            rotateGunToSlot(room.currentTurnSlot);

            const me = players[myId];
            const isMyTurn = me && !me.isDead && me.slot === room.currentTurnSlot;
            
            if (isMyTurn) {
                document.getElementById('btn-trigger').classList.remove('hidden');
                $mobileTrigger.classList.add('active');
                document.getElementById('watching-msg').classList.add('hidden');
                showMessage("SUA VEZ", "Puxe o gatilho...", 2000);
            } else {
                document.getElementById('btn-trigger').classList.add('hidden');
                $mobileTrigger.classList.remove('active');
                if (!me || me.isDead) {
                    document.getElementById('watching-msg').classList.remove('hidden');
                    document.getElementById('watching-msg').innerHTML = '<p class="text-gray-500 text-lg"><i class="fas fa-skull mr-2"></i> Voc√™ est√° morto. Observando...</p>';
                } else {
                    document.getElementById('watching-msg').classList.remove('hidden');
                    document.getElementById('watching-msg').innerHTML = '<p class="text-gray-500 text-lg"><i class="fas fa-hourglass-half mr-2"></i> Aguardando turno...</p>';
                }
            }
        }

        async function handleRestart() {
            showMessage("NOVA RODADA", "Reiniciando...", 2000);
            
            $bloodOverlay.style.opacity = 0;
            
            if (isHost) {
                const snap = await get(ref(db, `rooms/${currentRoom}/players`));
                const players = snap.val();
                const updates = {};
                const slots = [];
                
                Object.entries(players).forEach(([pid, p]) => {
                    updates[`players/${pid}/isDead`] = false;
                    slots.push(p.slot);
                });
                
                slots.sort((a, b) => a - b);
                
                updates.status = 'playing';
                updates.bulletPos = Math.floor(Math.random() * 6);
                updates.chamber = 0;
                updates.currentTurnSlot = slots[0];
                updates.round = (gameData?.round || 1) + 1;
                updates.lastAction = null;
                
                await update(ref(db, `rooms/${currentRoom}`), updates);
            }
            
            // Reset 3D meshes - restaura todos os personagens
            Object.values(playerMeshes).forEach(mesh => {
                if (!mesh || !mesh.userData) return;
                
                mesh.rotation.x = 0;
                mesh.rotation.y = 0;
                mesh.rotation.z = 0;
                mesh.position.y = -5;
                mesh.userData.isDead = false;
                
                if (mesh.userData.headGroup) {
                    mesh.userData.headGroup.visible = true;
                    mesh.userData.headGroup.scale.set(1, 1, 1);
                    mesh.userData.headGroup.rotation.set(0, 0, 0);
                }
                if (mesh.userData.torso) {
                    mesh.userData.torso.scale.set(1, 1, 1);
                }
                
                // Reposiciona o personagem
                const angle = mesh.userData.slot * (Math.PI * 2 / 6) - Math.PI / 2;
                const radius = 24;
                mesh.position.set(
                    Math.cos(angle) * radius,
                    -5,
                    Math.sin(angle) * radius
                );
                mesh.lookAt(0, -3, 0);
            });
            
            // Limpa labels e recria
            $labels3d.innerHTML = '';
        }

        async function pullTrigger() {
            const btn = document.getElementById('btn-trigger');
            btn.classList.add('hidden');
            $mobileTrigger.classList.remove('active');
            btn.disabled = true;
            
            const snap = await get(ref(db, `rooms/${currentRoom}`));
            const room = snap.val();
            const players = room.players || {};
            
            const isBang = room.chamber === room.bulletPos;
            
            if (cylinderMesh) cylinderMesh.rotation.z += Math.PI / 3;
            
            if (isBang) {
                await update(ref(db, `rooms/${currentRoom}/players/${myId}`), { isDead: true });
                
                const alivePlayers = Object.entries(players)
                    .filter(([pid, p]) => pid !== myId && !p.isDead)
                    .sort((a, b) => a[1].slot - b[1].slot);
                
                let nextSlot = room.currentTurnSlot;
                if (alivePlayers.length > 0) {
                    const next = alivePlayers.find(([_, p]) => p.slot > room.currentTurnSlot) || alivePlayers[0];
                    nextSlot = next[1].slot;
                }
                
                await update(ref(db, `rooms/${currentRoom}`), {
                    chamber: (room.chamber + 1) % 6,
                    currentTurnSlot: nextSlot,
                    lastAction: { type: 'bang', slot: mySlot, name: myName, time: Date.now() }
                });
                
                showMessage("VOC√ä MORREU", "üíÄüíÄüíÄ", 3000);
                
            } else {
                const alivePlayers = Object.entries(players)
                    .filter(([_, p]) => !p.isDead)
                    .sort((a, b) => a[1].slot - b[1].slot);
                
                const next = alivePlayers.find(([_, p]) => p.slot > room.currentTurnSlot) || alivePlayers[0];
                
                await update(ref(db, `rooms/${currentRoom}`), {
                    chamber: (room.chamber + 1) % 6,
                    currentTurnSlot: next[1].slot,
                    lastAction: { type: 'click', slot: mySlot, time: Date.now() }
                });
                
                showMessage("CLICK", "Voc√™ sobreviveu...", 1500);
            }
            
            btn.disabled = false;
        }

        document.getElementById('btn-trigger').onclick = pullTrigger;
        $mobileTrigger.onclick = pullTrigger;

        function showMessage(title, sub, duration) {
            $msgText.textContent = title;
            $msgSub.textContent = sub;
            $gameMessage.style.opacity = 1;
            setTimeout(() => $gameMessage.style.opacity = 0, duration);
        }

        // ====== CHAT ======

        document.getElementById('btn-send-chat').onclick = sendChat;
        $chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        function sendChat() {
            const text = $chatInput.value.trim();
            if (!text || !currentRoom) return;
            
            push(ref(db, `rooms/${currentRoom}/chat`), {
                name: myName,
                avatar: myAvatar,
                avatarUrl: myAvatarUrl || null,
                text: text,
                time: Date.now()
            });
            
            $chatInput.value = '';
        }

        // ====== 3D ======

        function init3D() {
            // Evita reinicializa√ß√£o
            if (scene) return;
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x080000, 0.008);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 60);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // Lighting
            const ambient = new THREE.AmbientLight(0x1a0000, 0.4);
            scene.add(ambient);
            
            const spot = new THREE.SpotLight(0xffeedd, 1.5);
            spot.position.set(0, 60, 0);
            spot.angle = Math.PI / 2.5;
            spot.penumbra = 0.6;
            spot.castShadow = true;
            spot.shadow.mapSize.width = 2048;
            spot.shadow.mapSize.height = 2048;
            scene.add(spot);
            
            // Luz extra para iluminar melhor os personagens
            const fillLight = new THREE.PointLight(0xffffee, 0.4, 100);
            fillLight.position.set(0, 20, 0);
            scene.add(fillLight);
            
            const redLight = new THREE.PointLight(0x660000, 0.8, 60);
            redLight.position.set(-25, 12, -25);
            scene.add(redLight);

            const redLight2 = new THREE.PointLight(0x440000, 0.6, 60);
            redLight2.position.set(25, 12, 25);
            scene.add(redLight2);
            
            // Table - maior para acomodar os personagens
            const tableGeo = new THREE.CylinderGeometry(20, 20, 2.5, 64);
            const tableMat = new THREE.MeshStandardMaterial({ 
                color: 0x2a1a10, 
                roughness: 0.4,
                metalness: 0.15
            });
            const table = new THREE.Mesh(tableGeo, tableMat);
            table.position.y = -1.25;
            table.receiveShadow = true;
            table.castShadow = true;
            scene.add(table);
            
            // Table edge ring
            const edgeGeo = new THREE.TorusGeometry(20, 0.5, 16, 64);
            const edgeMat = new THREE.MeshStandardMaterial({ color: 0x1a0a05, roughness: 0.3, metalness: 0.5 });
            const edge = new THREE.Mesh(edgeGeo, edgeMat);
            edge.rotation.x = Math.PI / 2;
            edge.position.y = 0;
            scene.add(edge);
            
            // Table felt - verde escuro
            const feltGeo = new THREE.CircleGeometry(19, 64);
            feltGeo.rotateX(-Math.PI / 2);
            const feltMat = new THREE.MeshStandardMaterial({ color: 0x0a2a0a, roughness: 0.9 });
            const felt = new THREE.Mesh(feltGeo, feltMat);
            felt.position.y = 0.02;
            felt.receiveShadow = true;
            scene.add(felt);
            
            // Floor
            const floorGeo = new THREE.PlaneGeometry(400, 400);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x030101, roughness: 1 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -18;
            floor.receiveShadow = true;
            scene.add(floor);
            
            createSmithWessonRevolver();
            
            clock = new THREE.Clock();
            window.addEventListener('resize', onResize);
            animate();
        }

        function createSmithWessonRevolver() {
            magnumGun = new THREE.Group();
            
            const metalDark = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.95, roughness: 0.15 });
            const metalShiny = new THREE.MeshStandardMaterial({ color: 0x3a3a3a, metalness: 0.98, roughness: 0.08 });
            const wood = new THREE.MeshStandardMaterial({ color: 0x4a2510, roughness: 0.4, metalness: 0 });
            const black = new THREE.MeshBasicMaterial({ color: 0x000000 });
            
            // Barrel - shorter, more realistic
            const barrelOuter = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.28, 4, 24), metalShiny);
            barrelOuter.rotation.x = Math.PI / 2;
            barrelOuter.position.z = 2.5;
            barrelOuter.castShadow = true;
            magnumGun.add(barrelOuter);
            
            // Barrel hole
            const barrelHole = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.3, 16), black);
            barrelHole.rotation.x = Math.PI / 2;
            barrelHole.position.z = 4.6;
            magnumGun.add(barrelHole);
            
            // Barrel shroud/lug underneath
            const shroud = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.2, 3.5), metalDark);
            shroud.position.set(0, -0.25, 2.3);
            magnumGun.add(shroud);
            
            // Front sight
            const frontSight = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.18, 0.15), metalShiny);
            frontSight.position.set(0, 0.35, 4.3);
            magnumGun.add(frontSight);
            
            // Rear sight
            const rearSight = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.12, 0.1), metalDark);
            rearSight.position.set(0, 0.35, 0.8);
            magnumGun.add(rearSight);
            
            // Frame body
            const frameBody = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.4, 2.2), metalDark);
            frameBody.position.set(0, 0, -0.3);
            magnumGun.add(frameBody);
            
            // Cylinder
            cylinderMesh = new THREE.Group();
            
            const cylBody = new THREE.Mesh(new THREE.CylinderGeometry(0.85, 0.85, 1.5, 32), metalShiny);
            cylBody.rotation.x = Math.PI / 2;
            cylBody.castShadow = true;
            cylinderMesh.add(cylBody);
            
            // Cylinder flutes and chambers
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                
                // Chamber hole
                const chamber = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2, 0.2, 1.55, 12), 
                    black
                );
                chamber.rotation.x = Math.PI / 2;
                chamber.position.set(Math.cos(angle) * 0.48, Math.sin(angle) * 0.48, 0);
                cylinderMesh.add(chamber);
            }
            
            cylinderMesh.position.set(0, 0, 0.5);
            magnumGun.add(cylinderMesh);
            
            // Trigger guard
            const guardShape = new THREE.Shape();
            guardShape.moveTo(0, 0);
            guardShape.quadraticCurveTo(0.5, -0.6, 0, -1);
            guardShape.quadraticCurveTo(-0.5, -0.6, 0, 0);
            
            const guardGeo = new THREE.ExtrudeGeometry(guardShape, { depth: 0.08, bevelEnabled: false });
            const guard = new THREE.Mesh(guardGeo, metalDark);
            guard.position.set(0, -0.7, -0.8);
            guard.rotation.y = Math.PI / 2;
            magnumGun.add(guard);
            
            // Trigger
            const trigger = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.5, 0.15), metalShiny);
            trigger.position.set(0, -0.9, -0.85);
            trigger.rotation.x = -0.2;
            magnumGun.add(trigger);
            
            // Hammer
            const hammer = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.6, 0.35), metalShiny);
            hammer.position.set(0, 0.7, -1.4);
            hammer.rotation.x = -0.3;
            magnumGun.add(hammer);
            
            // Grip
            const grip = new THREE.Mesh(new THREE.BoxGeometry(0.9, 2.2, 1.4), wood);
            grip.position.set(0, -1.8, -1.8);
            grip.rotation.x = 0.25;
            grip.castShadow = true;
            magnumGun.add(grip);
            
            // Grip texture lines
            for (let i = 0; i < 6; i++) {
                const line = new THREE.Mesh(
                    new THREE.BoxGeometry(0.03, 0.18, 1.2),
                    new THREE.MeshStandardMaterial({ color: 0x2a1508 })
                );
                line.position.set(0.48, -1.3 - i * 0.25, -1.8);
                line.rotation.x = 0.25;
                magnumGun.add(line);
                
                const line2 = line.clone();
                line2.position.x = -0.48;
                magnumGun.add(line2);
            }
            
            magnumGun.position.y = 1.8;
            magnumGun.scale.set(0.8, 0.8, 0.8);
            scene.add(magnumGun);
        }

        function createPlayerMesh(id, data) {
            const group = new THREE.Group();
            const angle = data.slot * (Math.PI * 2 / 6) - Math.PI / 2;
            const radius = 24;
            
            group.position.set(
                Math.cos(angle) * radius,
                -5,
                Math.sin(angle) * radius
            );
            group.lookAt(0, -3, 0);
            
            const colors = [0x8b0000, 0x006400, 0x00008b, 0x8b8b00, 0x008b8b, 0x4b0082];
            const skinTone = 0xe8beac;
            
            const clothMat = new THREE.MeshStandardMaterial({ color: colors[data.slot] || 0x333333, roughness: 0.6 });
            const skinMat = new THREE.MeshStandardMaterial({ color: skinTone, roughness: 0.4 });
            const hairMat = new THREE.MeshStandardMaterial({ color: 0x1a1209, roughness: 0.8 });
            
            // Body/Torso
            const torso = new THREE.Mesh(new THREE.BoxGeometry(5, 7, 3), clothMat);
            torso.position.y = 3.5;
            torso.castShadow = true;
            group.add(torso);
            group.userData.torso = torso;
            
            // Shoulders
            const shoulderL = new THREE.Mesh(new THREE.SphereGeometry(1.1, 16, 16), clothMat);
            shoulderL.position.set(-3.2, 5.8, 0);
            group.add(shoulderL);
            
            const shoulderR = new THREE.Mesh(new THREE.SphereGeometry(1.1, 16, 16), clothMat);
            shoulderR.position.set(3.2, 5.8, 0);
            group.add(shoulderR);
            
            // Arms
            const armL = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.5, 5, 12), clothMat);
            armL.position.set(-3.8, 2, 2.8);
            armL.rotation.x = -1;
            armL.rotation.z = 0.2;
            group.add(armL);
            
            const armR = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.5, 5, 12), clothMat);
            armR.position.set(3.8, 2, 2.8);
            armR.rotation.x = -1;
            armR.rotation.z = -0.2;
            group.add(armR);
            
            // Hands
            const handL = new THREE.Mesh(new THREE.SphereGeometry(0.6, 12, 12), skinMat);
            handL.position.set(-3.2, 0, 5.5);
            group.add(handL);
            
            const handR = new THREE.Mesh(new THREE.SphereGeometry(0.6, 12, 12), skinMat);
            handR.position.set(3.2, 0, 5.5);
            group.add(handR);
            
            // Neck
            const neck = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.8, 1.5, 12), skinMat);
            neck.position.y = 7.8;
            group.add(neck);
            
            // Head Group
            const headGroup = new THREE.Group();
            headGroup.position.y = 9.5;
            group.add(headGroup);
            
            // Head
            const head = new THREE.Mesh(new THREE.SphereGeometry(1.8, 24, 24), skinMat);
            head.scale.set(1, 1.15, 1);
            head.castShadow = true;
            headGroup.add(head);
            
            // Eyes
            const eyeWhite = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const eyePupil = new THREE.MeshBasicMaterial({ color: 0x000000 });
            
            const eyeL = new THREE.Mesh(new THREE.SphereGeometry(0.28, 12, 12), eyeWhite);
            eyeL.position.set(-0.55, 0.35, 1.55);
            headGroup.add(eyeL);
            
            const pupilL = new THREE.Mesh(new THREE.SphereGeometry(0.14, 8, 8), eyePupil);
            pupilL.position.set(-0.55, 0.35, 1.78);
            headGroup.add(pupilL);
            
            const eyeR = new THREE.Mesh(new THREE.SphereGeometry(0.28, 12, 12), eyeWhite);
            eyeR.position.set(0.55, 0.35, 1.55);
            headGroup.add(eyeR);
            
            const pupilR = new THREE.Mesh(new THREE.SphereGeometry(0.14, 8, 8), eyePupil);
            pupilR.position.set(0.55, 0.35, 1.78);
            headGroup.add(pupilR);
            
            // Eyebrows
            const browL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.15), hairMat);
            browL.position.set(-0.55, 0.75, 1.65);
            browL.rotation.z = 0.15;
            headGroup.add(browL);
            
            const browR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.15), hairMat);
            browR.position.set(0.55, 0.75, 1.65);
            browR.rotation.z = -0.15;
            headGroup.add(browR);
            
            // Nose
            const nose = new THREE.Mesh(new THREE.ConeGeometry(0.18, 0.5, 8), skinMat);
            nose.position.set(0, 0, 1.85);
            nose.rotation.x = Math.PI / 2;
            headGroup.add(nose);
            
            // Mouth
            const mouth = new THREE.Mesh(new THREE.BoxGeometry(0.55, 0.12, 0.1), new THREE.MeshBasicMaterial({ color: 0x8b4040 }));
            mouth.position.set(0, -0.55, 1.7);
            headGroup.add(mouth);
            
            // Hair
            const hair = new THREE.Mesh(
                new THREE.SphereGeometry(1.95, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2.2),
                hairMat
            );
            hair.position.y = 0.35;
            hair.rotation.x = -0.15;
            headGroup.add(hair);
            
            // Ears
            const earL = new THREE.Mesh(new THREE.SphereGeometry(0.3, 8, 8), skinMat);
            earL.scale.set(0.5, 1, 0.6);
            earL.position.set(-1.75, 0, 0);
            headGroup.add(earL);
            
            const earR = new THREE.Mesh(new THREE.SphereGeometry(0.3, 8, 8), skinMat);
            earR.scale.set(0.5, 1, 0.6);
            earR.position.set(1.75, 0, 0);
            headGroup.add(earR);
            
            group.userData = { 
                id, 
                slot: data.slot, 
                headGroup, 
                isDead: data.isDead,
                offset: Math.random() * 100
            };
            
            if (data.isDead) {
                headGroup.visible = false;
                group.rotation.x = -1.5;
            }
            
            scene.add(group);
            playerMeshes[id] = group;
            
            createLabel(id, data);
            
            return group;
        }

        function createLabel(id, data) {
            const label = document.createElement('div');
            label.id = `label-${id}`;
            label.className = 'label-3d';
            
            let micHtml = '';
            if (id === myId) {
                micHtml = `<div class="mic-status ${isMuted ? 'off' : 'on'}">
                    <i class="fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>
                    <span>${isMuted ? 'MUDO' : 'AO VIVO'}</span>
                </div>`;
            }
            
            const avatarHtml = data.avatarUrl 
                ? `<div class="avatar-display"><img src="${data.avatarUrl}" alt=""></div>`
                : `<div class="avatar-display">${data.avatar || 'üíÄ'}</div>`;
            
            label.innerHTML = `
                ${avatarHtml}
                <span>${data.name}${id === myId ? ' (voc√™)' : ''}</span>
                ${micHtml}
            `;
            
            $labels3d.appendChild(label);
        }

        function update3DPlayers(players, currentTurnSlot) {
            // Remove old
            Object.keys(playerMeshes).forEach(id => {
                if (!players[id]) {
                    scene.remove(playerMeshes[id]);
                    delete playerMeshes[id];
                    const label = document.getElementById(`label-${id}`);
                    if (label) label.remove();
                }
            });
            
            // Add/update
            Object.entries(players).forEach(([id, data]) => {
                if (!playerMeshes[id]) {
                    createPlayerMesh(id, data);
                }
                
                const mesh = playerMeshes[id];
                const label = document.getElementById(`label-${id}`);
                
                if (label) {
                    label.classList.toggle('current-turn', data.slot === currentTurnSlot && !data.isDead);
                    label.classList.toggle('dead', data.isDead);
                    
                    if (id === myId) {
                        const micStatus = label.querySelector('.mic-status');
                        if (micStatus) {
                            micStatus.className = `mic-status ${isMuted ? 'off' : 'on'}`;
                            micStatus.innerHTML = `
                                <i class="fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>
                                <span>${isMuted ? 'MUDO' : 'AO VIVO'}</span>
                            `;
                        }
                    }
                }
                
                if (data.isDead && mesh.userData.headGroup?.visible) {
                    mesh.userData.headGroup.visible = false;
                }
            });
            
            // Camera position - further away for better view
            const myPlayer = players[myId];
            if (myPlayer && camera) {
                const angle = myPlayer.slot * (Math.PI * 2 / 6) - Math.PI / 2;
                const camX = Math.cos(angle) * 55;
                const camZ = Math.sin(angle) * 55;
                const targetPos = new THREE.Vector3(camX, 30, camZ);
                camera.position.lerp(targetPos, 0.05);
                camera.lookAt(0, 2, 0);
            }
        }

        function rotateGunToSlot(slot) {
            if (!magnumGun) return;
            const angle = slot * (Math.PI * 2 / 6) - Math.PI / 2;
            
            const targetY = -angle;
            let spins = 0;
            const maxSpins = 15;
            
            const spinInterval = setInterval(() => {
                magnumGun.rotation.y += 0.6;
                spins++;
                if (spins >= maxSpins) {
                    clearInterval(spinInterval);
                    magnumGun.rotation.y = targetY;
                }
            }, 16);
        }

        function createMassiveGore(pos) {
            // Blood particles
            for (let i = 0; i < 350; i++) {
                const geo = new THREE.SphereGeometry(0.08 + Math.random() * 0.2, 5, 5);
                const mat = new THREE.MeshBasicMaterial({ 
                    color: new THREE.Color().setHSL(0, 1, 0.15 + Math.random() * 0.25)
                });
                const particle = new THREE.Mesh(geo, mat);
                particle.position.copy(pos);
                scene.add(particle);
                
                particles.push({
                    mesh: particle,
                    vel: new THREE.Vector3(
                        (Math.random() - 0.5) * 30,
                        Math.random() * 25,
                        (Math.random() - 0.5) * 30
                    ),
                    age: 0,
                    maxAge: 2 + Math.random() * 2.5
                });
            }
            
            // Gore chunks
            for (let i = 0; i < 25; i++) {
                const size = Math.random() * 0.7 + 0.2;
                const geo = new THREE.BoxGeometry(size, size * 1.2, size * 0.8);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: new THREE.Color().setHSL(0, 0.85, 0.12 + Math.random() * 0.08),
                    roughness: 0.2
                });
                const chunk = new THREE.Mesh(geo, mat);
                chunk.position.copy(pos);
                scene.add(chunk);
                
                particles.push({
                    mesh: chunk,
                    vel: new THREE.Vector3(
                        (Math.random() - 0.5) * 22,
                        Math.random() * 18,
                        (Math.random() - 0.5) * 22
                    ),
                    angVel: new THREE.Vector3(
                        Math.random() * 12,
                        Math.random() * 12,
                        Math.random() * 12
                    ),
                    age: 0,
                    maxAge: 4 + Math.random() * 3,
                    isChunk: true
                });
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!scene || !camera || !renderer) return;
            
            const dt = Math.min(clock.getDelta(), 0.1); // Limita delta time
            const time = clock.getElapsedTime();
            
            // Rota√ß√£o suave da arma (idle)
            if (magnumGun && !gameData?.status) {
                magnumGun.rotation.y += 0.005;
            }
            
            // Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.age += dt;
                
                p.mesh.position.add(p.vel.clone().multiplyScalar(dt));
                p.vel.y -= 35 * dt;
                
                if (p.isChunk && p.angVel) {
                    p.mesh.rotation.x += p.angVel.x * dt;
                    p.mesh.rotation.y += p.angVel.y * dt;
                    p.mesh.rotation.z += p.angVel.z * dt;
                }
                
                if (p.age > p.maxAge * 0.7) {
                    p.mesh.material.opacity = 1 - (p.age - p.maxAge * 0.7) / (p.maxAge * 0.3);
                    p.mesh.material.transparent = true;
                }
                
                if (p.age > p.maxAge) {
                    scene.remove(p.mesh);
                    particles.splice(i, 1);
                }
            }
            
            // Animate players - respira√ß√£o e movimento
            Object.values(playerMeshes).forEach(mesh => {
                if (!mesh || !mesh.userData) return;
                if (mesh.userData.isDead) return;
                
                const offset = mesh.userData.offset || 0;
                
                // Respira√ß√£o sutil
                mesh.position.y = -5 + Math.sin(time * 1.5 + offset) * 0.08;
                
                // Movimento do torso (respira√ß√£o)
                if (mesh.userData.torso) {
                    mesh.userData.torso.scale.y = 1 + Math.sin(time * 1.5 + offset) * 0.02;
                    mesh.userData.torso.scale.x = 1 + Math.sin(time * 1.5 + offset + Math.PI) * 0.01;
                }
                
                // Movimento da cabe√ßa
                if (mesh.userData.headGroup) {
                    mesh.userData.headGroup.rotation.y = Math.sin(time * 0.3 + offset) * 0.12;
                    mesh.userData.headGroup.rotation.x = Math.sin(time * 0.2 + offset) * 0.06;
                    mesh.userData.headGroup.rotation.z = Math.sin(time * 0.4 + offset) * 0.03;
                }
            });
            
            // Update labels
            Object.entries(playerMeshes).forEach(([id, mesh]) => {
                const label = document.getElementById(`label-${id}`);
                if (!label) return;
                
                const pos = mesh.position.clone();
                pos.y += 15;
                pos.project(camera);
                
                const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-pos.y * 0.5 + 0.5) * window.innerHeight;
                
                label.style.left = `${x}px`;
                label.style.top = `${y}px`;
                label.style.display = pos.z > 1 ? 'none' : 'flex';
            });
            
            renderer.render(scene, camera);
        }

        // ====== AUDIO ======

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(1800, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.08);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                osc.start(now);
                osc.stop(now + 0.08);
            } else if (type === 'bang') {
                // Deep boom
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(120, now);
                osc.frequency.exponentialRampToValueAtTime(12, now + 0.9);
                gain.gain.setValueAtTime(3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
                osc.start(now);
                osc.stop(now + 0.9);
                
                // Noise
                const bufferSize = audioCtx.sampleRate * 0.7;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 1.3);
                }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(1.8, now);
                noise.connect(noiseGain);
                noiseGain.connect(audioCtx.destination);
                noise.start(now);
            }
        }

        // ====== MIC ======

        document.getElementById('btn-mic').onclick = async () => {
            if (!micStream) {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micStream.getAudioTracks()[0].enabled = false;
                } catch (e) {
                    console.error('Mic error:', e);
                    alert('N√£o foi poss√≠vel acessar o microfone');
                    return;
                }
            }
            
            isMuted = !isMuted;
            micStream.getAudioTracks()[0].enabled = !isMuted;
            
            const btn = document.getElementById('btn-mic');
            
            if (isMuted) {
                btn.classList.remove('border-green-500', 'text-green-500', 'shadow-[0_0_25px_rgba(0,255,0,0.6)]');
                btn.classList.add('border-red-500', 'text-red-500');
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                btn.classList.remove('border-red-500', 'text-red-500');
                btn.classList.add('border-green-500', 'text-green-500', 'shadow-[0_0_25px_rgba(0,255,0,0.6)]');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
            
            if (currentRoom) {
                update(ref(db, `rooms/${currentRoom}/players/${myId}/micOn`), !isMuted);
            }
            
            const myLabel = document.getElementById(`label-${myId}`);
            if (myLabel) {
                const micStatus = myLabel.querySelector('.mic-status');
                if (micStatus) {
                    micStatus.className = `mic-status ${isMuted ? 'off' : 'on'}`;
                    micStatus.innerHTML = `
                        <i class="fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>
                        <span>${isMuted ? 'MUDO' : 'AO VIVO'}</span>
                    `;
                }
            }
        };

    </script>
</body>
</html>
